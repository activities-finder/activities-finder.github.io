(()=>{"use strict";const t=new class{constructor(){this.list=[],this.map={}}unique(t){if(this.map.hasOwnProperty(t))throw new Error(`already exists: ${t}`);return this.map[t]=!0,this.list.push(t),t}names(){return this.list}},e=t.unique("url"),r=t.unique("q"),n=t.unique("pages"),i=t.unique("anchor"),s=t.unique("code"),o=t.unique("support"),a=t.unique("source"),c=t.names(),u=new class{unmarshal(t){return t}marshal(t){return t}},l=new class{unmarshal(t){return""!==t?t.split(","):null}marshal(t){return 0===t.length?"":t.join(",")}},h=new class{constructor(t,e){!function(t,e){for(let r=0;r<t.length;r++){const n=t[r];if(!e.hasOwnProperty(n))throw new Error(`missing converter for "${n}"`)}}(t,e);const r=new URLSearchParams(window.location.search.substring(1));this.criteriaNameConverterMap=e,this.buildCriteriaMap(function(t,e,r){const n={};for(let i=0;i<e.length;i++){const s=e[i];if(t.has(s)){const e=r[s],i=decodeURIComponent(t.get(s)).trim();if(""!==i){const t=e.unmarshal(i);null!==t&&(n[s]=t)}}}return n}(r,t,e))}getCriteria(t,e){return this.criteriaMap.hasOwnProperty(t)?this.criteriaMap[t]:e}setStringCriteria(t,e){""!==e?this.criteriaMap[t]=e:delete this.criteriaMap[t]}setAnyCriteria(t,e){this.criteriaMap[t]=e}setArrayCriteria(t,e){e.length>0?this.criteriaMap[t]=e:delete this.criteriaMap[t]}setBoolCriteria(t,e){!0===e?this.criteriaMap[t]=e:delete this.criteriaMap[t]}removeAlias(t,e){const r=this.getCriteria(t,[]).filter((t=>t!==e));this.setArrayCriteria(t,r)}remove(t){delete this.criteriaMap[t]}keep(...t){for(let e in this.criteriaMap)-1===t.indexOf(e)&&delete this.criteriaMap[e]}storeCurrentState(){this.buildCriteriaMap(this.criteriaMap),this.update()}update(){window.history.pushState(null,"",window.location.pathname+function(t){if(""===t)return"";const e=[];return""!==t&&e.push(t),"?"+e.join("&")}(this.criteria))}buildCriteriaMap(t){const e=[];for(let r in t)if(t.hasOwnProperty(r)){const n=this.criteriaNameConverterMap[r];e.push(r+"="+encodeURIComponent(n.marshal(t[r])))}this.criteriaMap=t,this.criteria=e.join("&")}}(c,{[e]:u,[r]:u,[n]:u,[i]:l,[s]:l,[o]:l,[a]:l}),f=h;class m{constructor(t){this.$elements=t}setState(t){const e=function(t,e){const r={};for(let e=0;e<t.length;e++)r[t[e]]=true;return r}(t);this.$elements.forEach((function(t){t.checked=e.hasOwnProperty(t.getAttribute("data-alias"))}))}onChange(t){const e=this.getState.bind(this);this.$elements.forEach((function(r){r.addEventListener("change",(function(){t(e())}))}))}getState(){const t=new Array;return this.$elements.forEach((function(e){e.checked&&t.push(e.getAttribute("data-alias"))})),t}}function d(t){return function(e){"Enter"===e.code&&t()}}const p="https://dou.ua/users/";class g{constructor(t,e,r,n){this.original=t,this.userURL=e,this.activitiesURL=r,this.success=n}}function y(t){if(!t.startsWith(p,0))return new g(t,"","",!1);const e=t.indexOf("/",p.length);if(-1===e)return new g(t,"","",!1);const r=t.substring(0,e)+"/",n=t.substring(0,e)+"/activities/";return new g(t,r,n,!0)}class w{constructor(t){this.value=t}text(){return Promise.resolve(this.value)}}class S{constructor(t,e){this.username=t,this.avatar=e}}class C{constructor(t,e,r,n){this.user=t,this.pages=e,this.totalPageCount=r,this.$originalCommentPageGroup=n}}const v=new class{constructor(t,e,r){this.prefix=t,this.ttl=e,this.ttlMemoryQuota=r}get(t){const e=localStorage.getItem(this.toKey(t));return null===e?null:JSON.parse(e).text}set(t,e,r=0){try{localStorage.setItem(this.toKey(t),JSON.stringify(function(t){return{text:t,created:Date.now()}}(e)))}catch(n){console.error(n,r),this.clear(r>=3,!0),this.set(t,e,r+1)}}clear(t,e){const r=[],n=Date.now();for(let i=0;i<localStorage.length;i++){const s=localStorage.key(i);if(this.isKey(s)){const i=JSON.parse(localStorage.getItem(s));(t||e&&i.created+this.ttlMemoryQuota<n||i.created+this.ttl<n)&&r.push(s)}}for(const t of r)localStorage.removeItem(t)}toKey(t){return this.prefix+t}isKey(t){return t.startsWith(this.prefix)}}("dou:",18e5,3e4);v.clear(!1,!1);class M{constructor(t,e){this.step=t,this.delay=e}increment(){const t=this.delay;return this.delay+=this.step,t}}function q(t,e){const r=v.get(t);if(null!==r)return Promise.resolve(new w(r));const n=e.increment();return new Promise((function(e,r){setTimeout((function(){fetch(t).then((function(t){return t.text()})).then((function(r){v.set(t,r),e(new w(r))})).catch(r)}),n)}))}function L(t){return!0}function b(t){if(null===t)return void(N.style.visibility="hidden");N.style.visibility="",T.src=t.user.avatar,H.innerHTML=t.user.username;const e=[];let n=0;const c=function(){const t=f.getCriteria(r,"").toLowerCase(),e=f.getCriteria(i,[]),n=f.getCriteria(s,[]),c=f.getCriteria(o,[]),u=f.getCriteria(a,[]),l=function(t){return""===t?L:function(e){return-1!==e.querySelector(".comment-item .b-typo").textContent.toLowerCase().indexOf(t)}}(t),h=function(t){if(1===t.length){const[e]=t;switch(e){case"with-anchor":return function(t){return null!==t.querySelector(".comment-item .b-typo a")};case"without-anchor":return function(t){return null===t.querySelector(".comment-item .b-typo a")}}}return L}(e),m=function(t){if(1===t.length){const[e]=t;switch(e){case"with-support":return function(t){return null!==t.querySelector(".sup-users")};case"without-support":return function(t){return null===t.querySelector(".sup-users")}}}return L}(c),d=function(t){if(1===t.length){const[e]=t;switch(e){case"with-code":return function(t){return null!==t.querySelector("pre")};case"without-code":return function(t){return null===t.querySelector("pre")}}}return L}(n),p=0===(g=u).length?L:function(t){const e=t.querySelector("a.date");if(null===e)return!1;const r=e.getAttribute("href");for(const t of g)if("forums"===t){if(r.startsWith("https://dou.ua/forums/"))return!0}else if("lenta"===t){if(r.startsWith("https://dou.ua/lenta/"))return!0}else if("calendar"===t&&r.startsWith("https://dou.ua/calendar/"))return!0;return!1};var g;return function(t){return h(t)&&d(t)&&m(t)&&p(t)&&l(t)}}();for(const r of t.$originalCommentPageGroup)for(const t of r.children)n+=1,c(t)&&e.push(t.cloneNode(!0));K.innerHTML=`Знайдено коментарів ${e.length} з ${n}`,W.innerHTML=`На ${t.pages} сторінках з ${t.totalPageCount}`,D.innerHTML="",D.append(...e)}const{setInputStateByURL:x,setCheckboxesStateByURL:E,setCheckboxStateByURL:I}=(j=f,{setInputStateByURL:function(t,e){t.value=j.getCriteria(e,"")},setCheckboxesStateByURL:function(t,e){t.setState(j.getCriteria(e,[]))},setCheckboxStateByURL:function(t,e){t.checked=j.getCriteria(e,!1)}});var j;const B=document.getElementById("js-user-url"),P=document.getElementById("js-search-query"),R=document.getElementById("js-show-page-count"),U=new m(document.querySelectorAll("input.js-criteria-anchor")),A=new m(document.querySelectorAll("input.js-criteria-code")),$=new m(document.querySelectorAll("input.js-criteria-support")),O=new m(document.querySelectorAll("input.js-criteria-source")),k=document.getElementById("js-search-submit"),N=document.getElementById("js-main"),T=document.getElementById("js-profile-avatar"),H=document.getElementById("js-profile-username"),K=document.getElementById("js-comments-count-stats"),W=document.getElementById("js-comments-page-stats"),D=document.getElementById("js-content-comments");{const t=y(f.getCriteria(e,""));B.value=t.userURL,k.disabled=""===t.activitiesURL}function J(t,e){t.onChange((function(t){f.setArrayCriteria(e,t),f.storeCurrentState(),F()}))}function F(){const t=y(B.value);f.setStringCriteria(e,t.userURL),f.setStringCriteria(r,P.value),f.storeCurrentState(),""!==t.activitiesURL?function(t,e,r){const n=new M(250,0);q(t,n).then((function(t){return t.text()})).then((function(i){const s=(new DOMParser).parseFromString(i,"text/html"),o=s.querySelector("div.top_wide.profile-head div.b-author div.name a"),a=s.querySelector("div.top_wide.profile-head div.b-author img.g-avatar"),c=new S(o.innerHTML,a.src),u=[s.querySelector("ul.items")],l=function(t){const e=t.querySelectorAll(".page");if(0===e.length)return 1;const r=e[e.length-1];return parseInt(r.textContent,10)}(s);if(1===l)return void r(new C(c,1,1,u));let h=0;h=""===e?Math.min(5,l):"all"===e?l:Math.min(parseInt(e),l);const f=[];for(let e=2;e<=h;e++)f.push(q(`${t}/${e}/`,n));Promise.all(f).then((function(t){return Promise.all(t.map((t=>t.text())))})).then((function(t){const e=new DOMParser;for(const r of t){const t=e.parseFromString(r,"text/html");u.push(t.querySelector("ul.items"))}r(new C(c,h,l,u))}))})).catch(console.error)}(t.activitiesURL,R.value,b):b(null)}var G,Q;x(P,r),x(R,n),E(U,i),E(A,s),E($,o),E(O,a),B.addEventListener("keyup",(function(t){const e=y(B.value);k.disabled=""===e.activitiesURL,d(F)(t)})),P.addEventListener("keyup",d(F)),Q=n,(G=R).addEventListener("change",(function(){f.setStringCriteria(Q,G.value),f.storeCurrentState(),F()})),J(U,i),J(A,s),J($,o),J(O,a),k.addEventListener("click",F),F()})();