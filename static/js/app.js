(()=>{"use strict";const t=new class{constructor(){this.list=[],this.map={}}unique(t){if(this.map.hasOwnProperty(t))throw new Error(`already exists: ${t}`);return this.map[t]=!0,this.list.push(t),t}names(){return this.list}},e=t.unique("url"),r=t.unique("q"),n=t.unique("pages"),i=t.unique("anchor"),s=t.unique("code"),o=t.unique("support"),u=t.unique("quote"),a=t.unique("source"),c=t.names(),l=new class{unmarshal(t){return t}marshal(t){return t}},h=new class{unmarshal(t){return""!==t?t.split(","):null}marshal(t){return 0===t.length?"":t.join(",")}},f=new class{constructor(t,e){!function(t,e){for(let r=0;r<t.length;r++){const n=t[r];if(!e.hasOwnProperty(n))throw new Error(`missing converter for "${n}"`)}}(t,e);const r=new URLSearchParams(window.location.search.substring(1));this.criteriaNameConverterMap=e,this.buildCriteriaMap(function(t,e,r){const n={};for(let i=0;i<e.length;i++){const s=e[i];if(t.has(s)){const e=r[s],i=decodeURIComponent(t.get(s)).trim();if(""!==i){const t=e.unmarshal(i);null!==t&&(n[s]=t)}}}return n}(r,t,e))}getCriteria(t,e){return this.criteriaMap.hasOwnProperty(t)?this.criteriaMap[t]:e}setStringCriteria(t,e){""!==e?this.criteriaMap[t]=e:delete this.criteriaMap[t]}setAnyCriteria(t,e){this.criteriaMap[t]=e}setArrayCriteria(t,e){e.length>0?this.criteriaMap[t]=e:delete this.criteriaMap[t]}setBoolCriteria(t,e){!0===e?this.criteriaMap[t]=e:delete this.criteriaMap[t]}removeAlias(t,e){const r=this.getCriteria(t,[]).filter((t=>t!==e));this.setArrayCriteria(t,r)}remove(t){delete this.criteriaMap[t]}keep(...t){for(let e in this.criteriaMap)-1===t.indexOf(e)&&delete this.criteriaMap[e]}storeCurrentState(){this.buildCriteriaMap(this.criteriaMap),this.update()}update(){window.history.pushState(null,"",window.location.pathname+function(t){if(""===t)return"";const e=[];return""!==t&&e.push(t),"?"+e.join("&")}(this.criteria))}buildCriteriaMap(t){const e=[];for(let r in t)if(t.hasOwnProperty(r)){const n=this.criteriaNameConverterMap[r];e.push(r+"="+encodeURIComponent(n.marshal(t[r])))}this.criteriaMap=t,this.criteria=e.join("&")}}(c,{[e]:l,[r]:l,[n]:l,[i]:h,[s]:h,[o]:h,[u]:h,[a]:h}),m=f;class d{constructor(t){this.$elements=t}setState(t){const e=function(t,e){const r={};for(let e=0;e<t.length;e++)r[t[e]]=true;return r}(t);this.$elements.forEach((function(t){t.checked=e.hasOwnProperty(t.getAttribute("data-alias"))}))}onChange(t){const e=this.getState.bind(this);this.$elements.forEach((function(r){r.addEventListener("change",(function(){t(e())}))}))}getState(){const t=new Array;return this.$elements.forEach((function(e){e.checked&&t.push(e.getAttribute("data-alias"))})),t}}function p(t){return function(e){"Enter"===e.code&&t()}}const g="https://dou.ua/users/";class y{constructor(t,e,r,n){this.original=t,this.userURL=e,this.activitiesURL=r,this.success=n}}function w(t){if(!t.startsWith(g,0))return new y(t,"","",!1);const e=t.indexOf("/",g.length);if(-1===e)return new y(t,"","",!1);const r=t.substring(0,e)+"/",n=t.substring(0,e)+"/activities/";return new y(t,r,n,!0)}class v{constructor(t){this.value=t}text(){return Promise.resolve(this.value)}}class S{constructor(t,e){this.username=t,this.avatar=e}}class C{constructor(t,e,r,n){this.user=t,this.pages=e,this.totalPageCount=r,this.$originalCommentPageGroup=n}}const q=new class{constructor(t,e,r){this.prefix=t,this.ttl=e,this.ttlMemoryQuota=r}get(t){const e=localStorage.getItem(this.toKey(t));return null===e?null:JSON.parse(e).text}set(t,e,r=0){try{localStorage.setItem(this.toKey(t),JSON.stringify(function(t){return{text:t,created:Date.now()}}(e)))}catch(n){console.error(n,r),this.clear(r>=3,!0),this.set(t,e,r+1)}}clear(t,e){const r=[],n=Date.now();for(let i=0;i<localStorage.length;i++){const s=localStorage.key(i);if(this.isKey(s)){const i=JSON.parse(localStorage.getItem(s));(t||e&&i.created+this.ttlMemoryQuota<n||i.created+this.ttl<n)&&r.push(s)}}for(const t of r)localStorage.removeItem(t)}toKey(t){return this.prefix+t}isKey(t){return t.startsWith(this.prefix)}}("dou:",18e5,3e4);q.clear(!1,!1);class L{constructor(t,e){this.step=t,this.delay=e}increment(){const t=this.delay;return this.delay+=this.step,t}}function M(t,e){const r=q.get(t);if(null!==r)return Promise.resolve(new v(r));const n=e.increment();return new Promise((function(e,r){setTimeout((function(){fetch(t).then((function(t){return t.text()})).then((function(r){q.set(t,r),e(new v(r))})).catch(r)}),n)}))}function b(t){return!0}function x(t){if(null===t)return void(W.style.visibility="hidden");W.style.visibility="",H.src=t.user.avatar,K.innerHTML=t.user.username;const e=[];let n=0;const c=function(){const t=m.getCriteria(r,"").toLowerCase(),e=m.getCriteria(i,[]),n=m.getCriteria(s,[]),c=m.getCriteria(o,[]),l=m.getCriteria(u,[]),h=m.getCriteria(a,[]),f=function(t){return""===t?b:function(e){return-1!==e.querySelector(".comment-item .b-typo").textContent.toLowerCase().indexOf(t)}}(t),d=function(t){if(1===t.length){const[e]=t;switch(e){case"with-anchor":return function(t){return null!==t.querySelector(".comment-item .b-typo a")};case"without-anchor":return function(t){return null===t.querySelector(".comment-item .b-typo a")}}}return b}(e),p=function(t){if(1===t.length){const[e]=t;switch(e){case"with-support":return function(t){return null!==t.querySelector(".sup-users")};case"without-support":return function(t){return null===t.querySelector(".sup-users")}}}return b}(c),g=function(t){if(1===t.length){const[e]=t;switch(e){case"with-code":return function(t){return null!==t.querySelector("pre")};case"without-code":return function(t){return null===t.querySelector("pre")}}}return b}(n),y=function(t){if(1===t.length){const[e]=t;switch(e){case"with-quote":return function(t){return null!==t.querySelector(".comment-item .b-typo blockquote")};case"without-quote":return function(t){return null===t.querySelector(".comment-item .b-typo blockquote")}}}return b}(l),w=0===(v=h).length?b:function(t){const e=t.querySelector("a.date");if(null===e)return!1;const r=e.getAttribute("href");for(const t of v)if("forums"===t){if(r.startsWith("https://dou.ua/forums/"))return!0}else if("lenta"===t){if(r.startsWith("https://dou.ua/lenta/"))return!0}else if("calendar"===t){if(r.startsWith("https://dou.ua/calendar/"))return!0}else if("gamedev"===t&&r.startsWith("https://gamedev.dou.ua/"))return!0;return!1};var v;return function(t){return d(t)&&g(t)&&p(t)&&y(t)&&w(t)&&f(t)}}();for(const r of t.$originalCommentPageGroup)for(const t of r.children)n+=1,c(t)&&e.push(t.cloneNode(!0));D.innerHTML=`Знайдено коментарів ${e.length} з ${n}`,J.innerHTML=`На ${t.pages} сторінках з ${t.totalPageCount}`,F.innerHTML="",F.append(...e)}const{setInputStateByURL:E,setCheckboxesStateByURL:R,setCheckboxStateByURL:U}=(I=m,{setInputStateByURL:function(t,e){t.value=I.getCriteria(e,"")},setCheckboxesStateByURL:function(t,e){t.setState(I.getCriteria(e,[]))},setCheckboxStateByURL:function(t,e){t.checked=I.getCriteria(e,!1)}});var I;const P=document.getElementById("js-user-url"),j=document.getElementById("js-search-query"),B=document.getElementById("js-show-page-count"),A=new d(document.querySelectorAll("input.js-criteria-anchor")),k=new d(document.querySelectorAll("input.js-criteria-code")),$=new d(document.querySelectorAll("input.js-criteria-support")),O=new d(document.querySelectorAll("input.js-criteria-quote")),N=new d(document.querySelectorAll("input.js-criteria-source")),T=document.getElementById("js-search-submit"),W=document.getElementById("js-main"),H=document.getElementById("js-profile-avatar"),K=document.getElementById("js-profile-username"),D=document.getElementById("js-comments-count-stats"),J=document.getElementById("js-comments-page-stats"),F=document.getElementById("js-content-comments");{const t=w(m.getCriteria(e,""));P.value=t.userURL,T.disabled=""===t.activitiesURL}function G(t,e){t.onChange((function(t){m.setArrayCriteria(e,t),m.storeCurrentState(),_()}))}E(j,r),E(B,n),R(A,i),R(k,s),R($,o),R(O,u),R(N,a);const Q=new class{constructor(){}get(t,e){return this.activitiesURL===t&&this.showPageCount===e?this.response:null}set(t,e,r){this.activitiesURL=t,this.showPageCount=e,this.response=r}};function _(){const t=w(P.value);if(m.setStringCriteria(e,t.userURL),m.setStringCriteria(r,j.value),m.storeCurrentState(),""===t.activitiesURL)return void x(null);const n=Q.get(t.activitiesURL,B.value);null===n?function(t,e,r){const n=new L(250,0);M(t,n).then((function(t){return t.text()})).then((function(i){const s=(new DOMParser).parseFromString(i,"text/html"),o=s.querySelector("div.top_wide.profile-head div.b-author div.name a"),u=s.querySelector("div.top_wide.profile-head div.b-author img.g-avatar"),a=new S(o.innerHTML,u.src),c=[s.querySelector("ul.items")],l=function(t){const e=t.querySelectorAll(".page");if(0===e.length)return 1;const r=e[e.length-1];return parseInt(r.textContent,10)}(s);if(1===l)return void r(new C(a,1,1,c));let h=0;h=""===e?Math.min(4,l):"all"===e?l:Math.min(parseInt(e),l);const f=[];for(let e=2;e<=h;e++)f.push(M(`${t}/${e}/`,n));Promise.all(f).then((function(t){return Promise.all(t.map((t=>t.text())))})).then((function(t){const e=new DOMParser;for(const r of t){const t=e.parseFromString(r,"text/html");c.push(t.querySelector("ul.items"))}r(new C(a,h,l,c))}))})).catch(console.error)}(t.activitiesURL,B.value,(function(e){Q.set(t.activitiesURL,B.value,e),x(e)})):x(n)}var z,V;P.addEventListener("keyup",(function(t){const e=w(P.value);T.disabled=""===e.activitiesURL,p(_)(t)})),j.addEventListener("keyup",p(_)),V=n,(z=B).addEventListener("change",(function(){m.setStringCriteria(V,z.value),m.storeCurrentState(),_()})),G(A,i),G(k,s),G($,o),G(O,u),G(N,a),T.addEventListener("click",_),_()})();