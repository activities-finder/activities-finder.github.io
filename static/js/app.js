(()=>{"use strict";const t=new class{constructor(){this.list=[],this.map={}}unique(t){if(this.map.hasOwnProperty(t))throw new Error(`already exists: ${t}`);return this.map[t]=!0,this.list.push(t),t}names(){return this.list}},e=t.unique("url"),r=t.unique("q"),n=t.unique("pages"),i=t.unique("anchor"),s=t.unique("code"),o=t.unique("support"),a=t.unique("source"),u=t.names(),c=new class{unmarshal(t){return t}marshal(t){return t}},l=new class{unmarshal(t){return""!==t?t.split(","):null}marshal(t){return 0===t.length?"":t.join(",")}},h=new class{constructor(t,e){!function(t,e){for(let r=0;r<t.length;r++){const n=t[r];if(!e.hasOwnProperty(n))throw new Error(`missing converter for "${n}"`)}}(t,e);const r=new URLSearchParams(window.location.search.substring(1));this.criteriaNameConverterMap=e,this.buildCriteriaMap(function(t,e,r){const n={};for(let i=0;i<e.length;i++){const s=e[i];if(t.has(s)){const e=r[s],i=decodeURIComponent(t.get(s)).trim();if(""!==i){const t=e.unmarshal(i);null!==t&&(n[s]=t)}}}return n}(r,t,e))}getCriteria(t,e){return this.criteriaMap.hasOwnProperty(t)?this.criteriaMap[t]:e}setStringCriteria(t,e){""!==e?this.criteriaMap[t]=e:delete this.criteriaMap[t]}setAnyCriteria(t,e){this.criteriaMap[t]=e}setArrayCriteria(t,e){e.length>0?this.criteriaMap[t]=e:delete this.criteriaMap[t]}setBoolCriteria(t,e){!0===e?this.criteriaMap[t]=e:delete this.criteriaMap[t]}removeAlias(t,e){const r=this.getCriteria(t,[]).filter((t=>t!==e));this.setArrayCriteria(t,r)}remove(t){delete this.criteriaMap[t]}keep(...t){for(let e in this.criteriaMap)-1===t.indexOf(e)&&delete this.criteriaMap[e]}storeCurrentState(){this.buildCriteriaMap(this.criteriaMap),this.update()}update(){window.history.pushState(null,"",window.location.pathname+function(t){if(""===t)return"";const e=[];return""!==t&&e.push(t),"?"+e.join("&")}(this.criteria))}buildCriteriaMap(t){const e=[];for(let r in t)if(t.hasOwnProperty(r)){const n=this.criteriaNameConverterMap[r];e.push(r+"="+encodeURIComponent(n.marshal(t[r])))}this.criteriaMap=t,this.criteria=e.join("&")}}(u,{[e]:c,[r]:c,[n]:c,[i]:l,[s]:l,[o]:l,[a]:l}),f=h;class p{constructor(t){this.$elements=t}setState(t){const e=function(t,e){const r={};for(let e=0;e<t.length;e++)r[t[e]]=true;return r}(t);this.$elements.forEach((function(t){t.checked=e.hasOwnProperty(t.getAttribute("data-alias"))}))}onChange(t){const e=this.getState.bind(this);this.$elements.forEach((function(r){r.addEventListener("change",(function(){t(e())}))}))}getState(){const t=new Array;return this.$elements.forEach((function(e){e.checked&&t.push(e.getAttribute("data-alias"))})),t}}function m(t){return function(e){"Enter"===e.code&&t()}}const d="https://dou.ua/users/";class g{constructor(t,e,r,n){this.original=t,this.userURL=e,this.activitiesURL=r,this.success=n}}function y(t){if(!t.startsWith(d,0))return new g(t,"","",!1);const e=t.indexOf("/",d.length);if(-1===e)return new g(t,"","",!1);const r=t.substring(0,e)+"/",n=t.substring(0,e)+"/activities/";return new g(t,r,n,!0)}class w{constructor(t){this.value=t}text(){return Promise.resolve(this.value)}}class S{constructor(t,e){this.username=t,this.avatar=e}}class C{constructor(t,e,r,n){this.user=t,this.pages=e,this.totalPageCount=r,this.$originalCommentPageGroup=n}}const v=new class{constructor(t,e){this.prefix=t,this.ttl=e}get(t){const e=localStorage.getItem(this.toKey(t));return null===e?null:JSON.parse(e).text}set(t,e){localStorage.setItem(this.toKey(t),JSON.stringify(this.toItem(e)))}clear(t){const e=[],r=Date.now();for(let n=0;n<localStorage.length;n++){const i=localStorage.key(n);if(this.isKey(i)){const n=JSON.parse(localStorage.getItem(i));(t||n.expired<r)&&e.push(i)}}for(const t of e)localStorage.removeItem(t)}toItem(t){return{text:t,expired:Date.now()+this.ttl}}toKey(t){return this.prefix+t}isKey(t){return t.startsWith(this.prefix)}}("dou:",36e5);function M(t,e){return new Promise((function(r,n){const i=v.get(t);null===i?setTimeout((function(){fetch(t).then((function(t){return t.text()})).then((function(e){v.set(t,e),r(new w(e))})).catch(n)}),e):r(new w(i))}))}function q(t){return!0}function L(t){if(null===t)return void(k.style.visibility="hidden");k.style.visibility="",N.src=t.user.avatar,T.innerHTML=t.user.username;const e=[];let n=0;const u=function(){const t=f.getCriteria(r,"").toLowerCase(),e=f.getCriteria(i,[]),n=f.getCriteria(s,[]),u=f.getCriteria(o,[]),c=f.getCriteria(a,[]),l=function(t){return""===t?q:function(e){return-1!==e.querySelector(".comment-item .b-typo").textContent.toLowerCase().indexOf(t)}}(t),h=function(t){if(1===t.length){const[e]=t;switch(e){case"with-anchor":return function(t){return null!==t.querySelector(".comment-item .b-typo a")};case"without-anchor":return function(t){return null===t.querySelector(".comment-item .b-typo a")}}}return q}(e),p=function(t){if(1===t.length){const[e]=t;switch(e){case"with-support":return function(t){return null!==t.querySelector(".sup-users")};case"without-support":return function(t){return null===t.querySelector(".sup-users")}}}return q}(u),m=function(t){if(1===t.length){const[e]=t;switch(e){case"with-code":return function(t){return null!==t.querySelector("pre")};case"without-code":return function(t){return null===t.querySelector("pre")}}}return q}(n),d=0===(g=c).length?q:function(t){const e=t.querySelector("a.date");if(null===e)return!1;const r=e.getAttribute("href");for(const t of g)if("forums"===t){if(r.startsWith("https://dou.ua/forums/"))return!0}else if("lenta"===t){if(r.startsWith("https://dou.ua/lenta/"))return!0}else if("calendar"===t&&r.startsWith("https://dou.ua/calendar/"))return!0;return!1};var g;return function(t){return h(t)&&m(t)&&p(t)&&d(t)&&l(t)}}();for(const r of t.$originalCommentPageGroup)for(const t of r.children)n+=1,u(t)&&e.push(t.cloneNode(!0));H.innerHTML=`Знайдено коментарів ${e.length} з ${n}`,K.innerHTML=`На ${t.pages} сторінках з ${t.totalPageCount}`,W.innerHTML="",W.append(...e)}v.clear(!1);const{setInputStateByURL:b,setCheckboxesStateByURL:x,setCheckboxStateByURL:I}=(E=f,{setInputStateByURL:function(t,e){t.value=E.getCriteria(e,"")},setCheckboxesStateByURL:function(t,e){t.setState(E.getCriteria(e,[]))},setCheckboxStateByURL:function(t,e){t.checked=E.getCriteria(e,!1)}});var E;const j=document.getElementById("js-user-url"),B=document.getElementById("js-search-query"),R=document.getElementById("js-show-page-count"),U=new p(document.querySelectorAll("input.js-criteria-anchor")),P=new p(document.querySelectorAll("input.js-criteria-code")),A=new p(document.querySelectorAll("input.js-criteria-support")),$=new p(document.querySelectorAll("input.js-criteria-source")),O=document.getElementById("js-search-submit"),k=document.getElementById("js-main"),N=document.getElementById("js-profile-avatar"),T=document.getElementById("js-profile-username"),H=document.getElementById("js-comments-count-stats"),K=document.getElementById("js-comments-page-stats"),W=document.getElementById("js-content-comments");{const t=y(f.getCriteria(e,""));j.value=t.userURL,O.disabled=""===t.activitiesURL}function D(t,e){t.onChange((function(t){f.setArrayCriteria(e,t),f.storeCurrentState(),J()}))}function J(){const t=y(j.value);f.setStringCriteria(e,t.userURL),f.setStringCriteria(r,B.value),f.storeCurrentState(),""!==t.activitiesURL?function(t,e,r){const n=[];M(t,100).then((function(t){return t.text()})).then((function(i){const s=(new DOMParser).parseFromString(i,"text/html"),o=s.querySelector("div.top_wide.profile-head div.b-author div.name a"),a=s.querySelector("div.top_wide.profile-head div.b-author img.g-avatar"),u=new S(o.innerHTML,a.src);n.push(s.querySelector("ul.items"));const c=function(t){const e=t.querySelectorAll(".page");if(0===e.length)return 1;const r=e[e.length-1];return parseInt(r.textContent,10)}(s);if(1===c)return void r(new C(u,1,1,n));let l=0;l=""===e?Math.min(5,c):"all"===e?c:Math.min(parseInt(e),c);const h=[];for(let e=2;e<=l;e++)h.push(M(`${t}/${e}/`,250*e));Promise.all(h).then((function(t){return Promise.all(t.map((t=>t.text())))})).then((function(t){const e=new DOMParser;for(const r of t){const t=e.parseFromString(r,"text/html");n.push(t.querySelector("ul.items"))}r(new C(u,l,c,n))}))})).catch(console.error)}(t.activitiesURL,R.value,L):L(null)}var F,G;b(B,r),b(R,n),x(U,i),x(P,s),x(A,o),x($,a),j.addEventListener("keyup",(function(t){const e=y(j.value);O.disabled=""===e.activitiesURL,m(J)(t)})),B.addEventListener("keyup",m(J)),G=n,(F=R).addEventListener("change",(function(){f.setStringCriteria(G,F.value),f.storeCurrentState(),J()})),D(U,i),D(P,s),D(A,o),D($,a),O.addEventListener("click",J),J()})();